# Port Scanning

```text
# Stealthy SYN Scan
root@kali:~$ nmap -sS <ip>
  -sS    Syn Scan

# See which ping type is being used, ARP by default
root@kali:~$ nmap <ip> -sn -PE --packet-trace
  -sn    Ping Scan
  -PE    Force ICMP Echo Requests
  --packet-trace    show packet route info
  --reason    Will show reason for port classification
  
# Options
--disable-arp-ping  # Disable ARP Ping
--top-ports=<num>   # Scan top X ports
-Pn                 # Disable ICMP Echo Requests
-n                  # Disable DNS resolution
-F                  # Fast Mode
-D                  # Decoy Scan Method
-S                  # Specify Source IP Address
-e                  # Interface
--dns-server <ns>   # Specify DNS server to use
--source-port <port># Source port of request-D



# Scan all ports, only show 'open' ports, not filtered/closed
root@kali:~$ nmap -p- --open <ip>

# Scan for UDP
root@kali:~$ nmap -sU <ip>
root@kali:~$ unicornscan -mU -v -I <ip>

# Scan for version, with scripts and OS detection
root@kali:~$ nmap -sV -sC -O -v -oA <file> <ip>

# Transform XML
root@kali:~$ xsltproc <file>.xml -o <file>.html

# All out aggressive scan, disable ICMP echo
root@kali:~$ nmap -v -Pn -A -p- <ip>

# Fast scan
root@kali:~$ nmap -F <ip>

# Scan 100 most common ports
root@kali:~$ nmap --top-ports 100 <ip>
```

### Firewall and IDS/IPS Evasion

Packets are dropped or rejected, dropped are ignored with no response. Reject have the `RST` flag set. Can contain ICMP error codes or be null

Nmap's `-sA` method is much harder to filter for firewalls and IDS/IPS than `-sS` and `-sT`

```text
# Scan using decoys
root@kali:~$ nmap <ip> -p <port> -sS -Pn -n --disable-arp-ping --packet-trace -D RND:5
```

## Metasploit

We can combine the powers of metasploit and nmap, by integrating nmap into metasploit.

### db\_nmap

You can run 'db\_nmap' and all the output will be stored in the metsploit database.  

This information can then be accessed via:

```text
msf5> hosts
msf5> services
```

You can also import the xml results of an nmap scan.

```text
msf5> db_import /path/to/file.xml
```

### PortScan Module

If for some reason you only have access to metasploit and not nmap, you can use a metasploit module to handle the port scan.

```text
msf5> use auxiliary/scanner/portscan/
```

